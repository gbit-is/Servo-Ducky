<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SDCC</title>
  <style>
    body { font-family: monospace; padding: 20px;background-color:floralwhite; }
    #terminal { width: 100%; height: 25vh; background: lightsteelblue; color: black; padding: 10px; overflow-y: auto; white-space: pre-wrap; }
    #input { width: 100%; }
    .slider_class {
	    width: 100%;

    }
    .container{
	height: 60vh;
    	display: flex;
	}
	.fixed{
    	width: 60%;
	}
	.flex-item{
    	flex-grow: 1;
	}
.container .scode{
  resize: none;
  outline: none;
  width: 100%;
  padding: 10px;
  height: 100%;
  background-color: black;
  color: greenyellow;
}


  </style>
</head>
<body>
		  <img src="https://raw.githubusercontent.com/gbit-is/Servo-Ducky/refs/heads/main/images/servo_ducky_cc_banner.svg" alt="servo_ducky_logo" style="height:2vh;">
		  <br>

  <button id="connect">Connect</button>
  <div id="terminal"></div>
  <input id="input" type="text" placeholder="Type a command..." />
  <br>

<div class="container">
	<!-- <div class="fixed" id="slider_container"></div> -->

	<div class="fixed">
  <div id="slider_container"></div>
  <div id="play controls" style="position: absolute; bottom: 5vh; " >

	  Execute Servo Ducky Functions
	<div id="function_container">
	</div>
	  <br>

	  Manage Scripts
	  <div>
		      <button id="run_script">run script</button>
		      <button id="open_script">open script</button>
		      <button id="save_script">save script</button>
		  </div>

  </div>


	</div>


  <div class="flex-item">

	  <!-- <textarea id="scode" name="scode" rows="20" cols="50">  </textarea> -->


	   <textarea class="scode" id="scode_box"></textarea>

  <br>

  </div>
</div>


  <script>
    let port;
    let reader;
    let writer;

    const terminal = document.getElementById('terminal');
    const input = document.getElementById('input');
    const connectButton = document.getElementById('connect');



    const filters = [
  	{ usbVendorId: 11914 }, 
	];

    function logToTerminal(data) {
      terminal.textContent += data;
      terminal.scrollTop = terminal.scrollHeight;
    }

    function isNumber(n) { return !isNaN(parseFloat(n)) && !isNaN(n - 0) }
    function cssEscape(id) { return CSS.escape(id);  }

    function getCookie(name) {
    const decodedCookies = decodeURIComponent(document.cookie);
    const cookies = decodedCookies.split(';');

    for (let cookie of cookies) {
        cookie = cookie.trim(); // Remove leading whitespace
        if (cookie.startsWith(name + "=")) {
            return cookie.substring((name + "=").length);
        }
    }
    	return null;
    }




    function on_slider_change(event) {

	    console.log("update slider ...")
	    let value = event.target.value;
	    let id = event.target.id
	    //console.log("on slider change .... ");
	    //console.log(value,id)

	    numbox_id = "numbox" + id

	    let number_box = document.getElementById(numbox_id);

	    //console.log(number_box);
	    number_box.innerHTML = value ;


	    command = "S" + id + " " + value
	    sendToSerial(command)


    }

    function execute_tmp_script() {

	    script_content = document.getElementById("scode_box").value


	    let script_b64 = btoa(script_content);
	    let command = "LOAD|" + script_b64;
	    console.log(script_b64)
	    sendToSerial(command)




    }

    function save_scode_to_cookie() {

	console.log("saving scode to cookie")
	let contents = document.getElementById("scode_box").value

	console.log(contents)
	document.cookie = "scode_contents=" + encodeURIComponent(contents)


	   }

    function add_to_textbox(line) {
	//console.log(line)
	document.getElementById("scode_box").value += line + "\n";

	save_scode_to_cookie()


    }

    function click_add(event) {
	    let servo_id = event.target.value;

	    let servo_value = document.getElementById(servo_id).value ; 

	    command = "S" + servo_id + " " + servo_value;

	    add_to_textbox(command);


    }

    function pad(width, string, padding) {
  	return (width <= string.length) ? string : pad(width, padding + string, padding)
	}

    function generate_sliders(servo_data) {



	const slider_box = document.getElementById("slider_container");


	    console.log("generate sliders")

	    //var servo_data = JSON.parse(servo_data_raw);
	    var br = document.createElement("br");

	    console.log(servo_data)
	    console.log("foo")

	    const slider_box_div = document.createElement("div");
	    slider_box_div.style.width = "100%";
	    slider_box_div.style.display= "table";

	    for ( const servo in servo_data) { 

		    console.log(servo);

		    var slider_row = document.createElement("div");

		    slider_row.style.display = "table-row";

		    let servo_id = servo_data[servo][0] ; 
		    let servo_range = servo_data[servo][1] ;
		    let servo_angle = servo_data[servo][2] ;



		    if ( ! isNumber(servo_angle) ) {
			    servo_angle_num = 0 ;
			    servo_angle_text = "Err" ;
		    } else {
			    servo_angle_num = Math.floor(servo_angle)
			    servo_angle_text = servo_angle_num
		    }


		    console.log(servo_angle_text)
		    servo_angle_text = pad(10,servo_angle_text," ")
		    console.log(servo_angle_text)
		    console.log("...")


		    var slider_div = document.createElement("div");
		    slider_div.style.display = "table-cell";
		    slider_div.style.width = "75%";

		    var servo_name_div = document.createElement("div");
		    servo_name_div.style.display = "table-cell";
		    servo_name_div.style.width = "8%";

		    var servo_name_span = document.createElement("span");
		    servo_name_span.textContent = "Servo " + servo_id ;

		    var slider = document.createElement("input");
		    slider.id = servo_id;
		    slider.type = "range";
		    slider.min = 0;
		    slider.max = servo_range;
		    slider.value = servo_angle_num;
		    slider.classList.add("slider_class");
		    slider.step = 1;
		    //slider.onchange = on_slider_change(event.target.id, event.target.value)
		    slider.addEventListener("input", function(event) {
  			  on_slider_change(event);
			});

		    var numbox_div = document.createElement("div");
		    numbox_div.style.display = "table-cell";
		    numbox_div.style.paddingLeft = "2%";

		    var numbox = document.createElement("span");
		    numbox.id = "numbox" + servo_id ;
		    numbox.classList.add("numbox_class")
		    numbox.textContent = servo_angle_text;

		    var addbutton_div = document.createElement("div");
		    addbutton_div.style.display = "table-cell";

		    let add_button = document.createElement("button");
		    add_button.innerHTML = "+" ; 
		    add_button.id = "add" + servo_id ; 
		    add_button.value = servo_id ;
		    //add_button.addEventListener("click",click_add)
		    add_button.addEventListener("click", function(event) {
  			  click_add(event);
			});



		    servo_name_div.appendChild(servo_name_span) 
		    slider_div.appendChild(slider)
		    numbox_div.appendChild(numbox)
		    addbutton_div.appendChild(add_button)

		    slider_row.appendChild(servo_name_div);
		    slider_row.appendChild(slider_div);
		    slider_row.appendChild(numbox_div);
		    slider_row.appendChild(addbutton_div);

		    slider_box_div.appendChild(slider_row);
		    

   		}
	    slider_box.append(slider_box_div);




    }

    function click_run_function(event){
	    let value = event.target.value;


	    command = "R " + value


	    sendToSerial(command)
	   }

    function generate_function_keys(function_list){

	    console.log(function_list)

	    const function_box = document.getElementById("function_container");

	    for ( const function_nr in function_list ) {

		    function_name = function_list[function_nr]


		    let func_button = document.createElement("button");
		    func_button.innerHTML = function_name ;
		    func_button.id = "function" + function_name ;
		    func_button.value = function_name ;
		    func_button.classList.add("flex-item")

		    func_button.addEventListener("click", function(event) {
  			  click_run_function(event);
		    });

		    function_box.append(func_button)
		    function_box.append(" ")


		}


	   }


    //let function_list = ['example_script_2', 'es1', 'example_script_1'];
    //generate_function_keys(function_list);

    //let servo_data_raw = '[[0, 180, 91.8033], [1, 180, 47.7377], [2, 180, 126.776], [3, 180, 54.7322], [4, 180, "Err_none"], [5, 180, "Err_none"], [6, 180, "Err_none"], [7, 180, "Err_none"], [8, 180, "Err_none"], [9, 180, "Err_none"], [10, 180, "Err_none"], [11, 180, "Err_none"], [12, 180, "Err_none"], [13, 180, "Err_none"], [14, 180, "Err_none"], [15, 180, "Err_none"], "DONE"]'
    //generate_sliders(servo_data_raw);


    async function connectSerial() {
      try {
	port = await navigator.serial.requestPort({ filters } );
	const info = port.getInfo();
	//console.log(info)
        await port.open({ baudRate: 9600 });

        logToTerminal("✅ Connected\n");


        // Setup writer
        writer = port.writable.getWriter();

        // Setup reader
        const decoder = new TextDecoderStream();
        const inputDone = port.readable.pipeTo(decoder.writable);
        const inputStream = decoder.readable;
        reader = inputStream.getReader();

	//sendToSerial("list_servos")
	sendToSerial("_SDCC_INIT")

	let init_data = "";

	while (true) {
      	  const { value, done } = await reader.read();
	  init_data += value
	  //console.log(servo_data)
	  if (init_data.includes("DONE")) break;
	}

	var init_data_json = JSON.parse(init_data);
	generate_sliders(init_data_json[0])
	generate_function_keys(init_data_json[1])
	


        // Read loop
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          if (value) logToTerminal(value);
        }

      } catch (err) {
        logToTerminal("❌ Error: " + err.message + "\n");
      }
    }

    async function sendToSerial(data) {
      if (!writer) {
        logToTerminal("⚠️ Not connected.\n");
        return;
      }
      const encoded = new TextEncoder().encode(data + "\r\n");
      await writer.write(encoded);
      logToTerminal("> " + data + "\n");
    }

    connectButton.addEventListener('click', connectSerial);

    input.addEventListener('keydown', async (e) => {
      if (e.key === 'Enter') {
        const value = input.value.trim();
        if (value !== '') {
          await sendToSerial(value);
          input.value = '';
        }
      }
    });

document.getElementById("open_script").addEventListener("click", function() {
    // Create a hidden file input
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".scode"; // restrict to .scode files

    // Handle file selection
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Read the file
        const reader = new FileReader();
        reader.onload = function(e) {
            const contents = e.target.result;
            document.getElementById("scode_box").value = contents;
    	    save_scode_to_cookie()
        };
        reader.readAsText(file); // read the file as text
    };



    // Trigger file picker
    input.click();

});


    document.getElementById("save_script").addEventListener("click", async function() {
    try {
        // Open a file save picker
        const handle = await window.showSaveFilePicker({
            suggestedName: "script.scode",
            types: [
                {
                    description: "Script Code Files",
                    accept: {
                        "text/plain": [".scode"]
                    }
                }
            ]
        });

        // Create a writable stream
        const writable = await handle.createWritable();

        // Get content from textarea
        const content = document.getElementById("scode_box").value;

        // Write content to file
        await writable.write(content);

        // Close the file and write to disk
        await writable.close();

        console.log("File saved successfully!");
    } catch (err) {
        if (err.name !== 'AbortError') {
            console.error("Save failed:", err);
        }
    }
});


    document.getElementById("run_script").addEventListener("click", execute_tmp_script);


    const savedContents = getCookie("scode_contents");

    if (savedContents !== null) {
	    if ( savedContents == "" ){
		    add_to_textbox("[main]")
	    } else {
        	document.getElementById("scode_box").value = savedContents;
		}

    } else {
	    add_to_textbox("[main]")
    }

    document.getElementById("scode_box").addEventListener("input", save_scode_to_cookie);



  </script>
</body>
</html>

